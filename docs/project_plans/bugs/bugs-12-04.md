# Identified Bugs - /gifts Navigation Crash

**Date:** 2025-12-04
**Previously Fixed Commit:** 77d88b9
**Prior Fix Attempts:** `.claude/worknotes/fixes/bug-fixes-2025-12.md`

## Context

This bug has persisted across numerous fix attempts, and even the recent overhaul of the codebase to simplify the websocket implementation - `docs/project_plans/implementation_plans/refactors/websocket-simplification-v1.md`.

It was originally fixed in commit 77d88b9, but has since re-emerged. The bug manifests when navigating to /gifts, and then attempting to navigate to /occasions, /people, or /lists using the sidebar buttons, which causes an immediate crash of the site. The crash does not occur when navigating directly via URL or using other navigation methods, or to other pages.

## Listed Items

1. Once a user navigates to /gifts, navigating to /occasions, /people, or /lists using sidebar buttons will immediately crash the site.
    - When I first refresh the site on /gifts after a failure, these are the immediate API calls:

    ```log
    INFO:     172.22.0.1:60086 - "GET /api/v1/auth/me HTTP/1.1" 200 OK
    INFO:     172.22.0.1:60134 - "WebSocket /ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzY0ODcwODQ5LCJpYXQiOjE3NjQ3ODQ0NDl9.EuEAS37LdHWT-ieL3GYEzz3CgunY0uB37Zou1WqYk7w" [accepted]
    INFO:     connection open
    INFO:     172.22.0.1:60086 - "GET /api/v1/persons HTTP/1.1" 200 OK
    INFO:     172.22.0.1:60116 - "GET /api/v1/occasions HTTP/1.1" 200 OK
    INFO:     172.22.0.1:60120 - "GET /api/v1/gifts?sort=recent HTTP/1.1" 200 OK
    INFO:     172.22.0.1:60100 - "GET /api/v1/lists HTTP/1.1" 200 OK
    ```

    - Current behaviors once on the /gifts page:
      - Navigating to /occasions, /people, or /lists using sidebar buttons will immediately crash.
      - I'm able to click on a gift card and the modal opens, which then fetches that /gifts/{id} endpoint, the /lists, and all /lists/{id} endpoints without a crash.
      - I can also then navigate to /dashboard and /assignments and even back to /gifts without crashing.
      - I can navigate to the /{id} pages for each of the 3 pages via buttons on the site, or directly via URL, without crash.
      - I can navigate to the 3 pages directly via URL without the site failing at any time.
      - The crash only occurs if I navigate to the above 3 sites via the side buttons, from any page, after navigating to /gifts.
      - It also occurs if, while on /gifts, I click on a linked List from within a Gift modal, which navigates to /lists/{id}. But I can still navigate to that page directly via URL without crash.

## Recommendations

A deep dive analysis was performed via GPT-5.1-Codex-Max with Extra High Reasoning. The following are the recommendations based on the findings. Implementation of these recommendations should be done via subagents as per the implementation execution guidelines.

### Likely hotspots

1. **List-heavy subscriptions on /gifts:** That page mounts GiftToolbar (uses GiftFilters → useLists, usePersons, useOccasions), AddGiftModal (includes list/person/occasion hooks), plus the globally mounted QuickAddModal (still calls useLists even when closed). Each useLists/usePersons/useOccasions carries a WebSocket subscription. The gifts page is the only one that piles these together; navigating from it to list/people/occasion pages (which also use the same hooks) could be multiplying subscriptions before the old ones tear down, leading to a subscription storm/WS flood and a hang.
2. **QuickAddModal always subscribing:** Because the guard is after the hooks, useLists({type:'ideas'}) runs on every page load, even when the modal is closed. That means a permanent WS subscription from the app shell. On /gifts, this adds to the pile and might push the WS manager over the edge when new page subscriptions spin up.
3. **Sidebar links prefetch:** The sidebar Links are always visible; Next.js will prefetch those routes. On /gifts, that means prefetching /lists,/people,/occasions while those pages’ data hooks are already alive in the current tree. Prefetch might be racing with live hooks and WS resubscribe logic, compounding the load when you click the link.
4. **Navigation-triggered resubscribe churn:** useRealtimeSync guards are already improved, but every useLists (and friends) still subscribes per-instance. On /gifts you have multiple instances; when you click a sidebar Link, the target page’s instances mount before the source ones unmount, briefly doubling/tripling subscriptions for the same topics. That’s a good candidate for the “hang then crash” you see only when coming from /gifts via client-side nav.

### Validation against prior fixes

- The fixes logged in `.claude/worknotes/fixes/bug-fixes-2025-12.md` addressed per-render resubscribes and lazy-mounting modals, but they didn’t unify or dedupe topic subscriptions across hook instances. Nor did they gate always-mounted shell modals (QuickAdd) from opening subscriptions when closed. The regression lines up with multiple concurrent subscribers, not the earlier per-render issue.

### Most plausible root cause to target next

A transient spike in WS subscriptions (and associated React Query listeners) when leaving /gifts via sidebar Links. Multiple `useLists`/`usePersons`/`useOccasions` instances are alive concurrently (shell + page + modals), and client-side navigation (plus prefetch) doubles them before teardown, overwhelming the WS manager and freezing the tab. Focus instrumentation on subscription counts and on gating always-on hooks (QuickAddModal, AddGiftModal) with `enabled` even when closed.
