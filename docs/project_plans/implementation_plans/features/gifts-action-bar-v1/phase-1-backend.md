---
title: "Phase 1: Backend Migration & Schemas"
description: "Alembic migration and schema updates for from_santa field"
audience: [developers, backend-engineers]
tags: [implementation, phase, backend, database, migration]
created: 2025-12-22
updated: 2025-12-22
category: "product-planning"
status: ready
---

# Phase 1: Backend Migration & Schemas

**Duration**: 2 business days (Days 1-2)
**Story Points**: 5 pts
**Assigned Subagent(s)**: python-backend-engineer, data-layer-expert
**Dependencies**: None (foundation phase)

---

## Phase Overview

Phase 1 prepares the backend to support the "From Santa" feature (F7) by adding a new database column, updating the ORM model, and expanding the API schemas. This is a quick, low-risk foundation phase that unblocks all frontend work in Phases 2-5.

**Key Deliverables**:
1. Alembic migration to add `from_santa` column to gifts table
2. Updated Gift SQLAlchemy model
3. Updated Pydantic schemas (GiftCreate, GiftUpdate, GiftResponse)
4. Local testing: POST/PATCH gift endpoints with new field

**Quality Gates**:
- [ ] Migration runs cleanly with no errors
- [ ] Gift model reflects new field
- [ ] All schemas validate correctly
- [ ] No breaking changes to API contract
- [ ] Backward compatibility maintained (default False)

---

## Task Breakdown

### T1.1: Create Alembic Migration File

**Story ID**: P1-T1
**Story Points**: 1 pt
**Assigned Subagent(s)**: data-layer-expert, python-backend-engineer

#### Description

Create a new Alembic migration file that adds the `from_santa` boolean column to the `gifts` table with a default value of `False` and `NOT NULL` constraint. The migration must support rolling back cleanly.

#### Acceptance Criteria

- [ ] Migration file created: `services/api/alembic/versions/YYYY_MM_DD_HH_MM_SS_add_gift_from_santa.py`
- [ ] Migration includes both `upgrade()` and `downgrade()` functions
- [ ] `upgrade()` adds `from_santa BOOLEAN NOT NULL DEFAULT FALSE` to gifts table
- [ ] `downgrade()` drops the column cleanly
- [ ] File has proper docstring describing the change
- [ ] No syntax errors when running `alembic current`
- [ ] Migration ID is correct and unique

#### Implementation Details

**File**: `services/api/alembic/versions/YYYY_MM_DD_HH_MM_SS_add_gift_from_santa.py`

```python
"""add gift from_santa field

Revision ID: <auto-generated>
Revises: <previous_revision>
Create Date: 2025-12-22 XX:XX:XX.XXXXXX

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '<auto-generated>'
down_revision = '<previous_revision>'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # Add from_santa column to gifts table
    op.add_column('gifts', sa.Column(
        'from_santa',
        sa.Boolean(),
        nullable=False,
        server_default=False,
        comment='Flag indicating gift is from Santa for personalization/surprise'
    ))


def downgrade() -> None:
    # Drop from_santa column
    op.drop_column('gifts', 'from_santa')
```

#### Key Notes

- Use `server_default=False` to ensure database-level default
- Boolean type automatically maps to BOOLEAN in PostgreSQL
- Comment added for clarity in schema
- No indexes needed (low-cardinality field)
- Downgrade mirrors upgrade for safe rollback

#### Testing Checklist

- [ ] Run `uv run alembic upgrade head` (from services/api)
- [ ] Verify `\d gifts` in psql shows `from_santa` column
- [ ] Check column type is `boolean` not `null`
- [ ] Check default is `false`
- [ ] Run `uv run alembic downgrade -1` to test rollback
- [ ] Verify column is removed
- [ ] Run upgrade again to confirm idempotency

---

### T1.2: Update Gift Model

**Story ID**: P1-T2
**Story Points**: 1 pt
**Assigned Subagent(s)**: python-backend-engineer

#### Description

Update the Gift SQLAlchemy model to include the new `from_santa` field as a mapped column with proper type hints and defaults.

#### Acceptance Criteria

- [ ] File: `services/api/app/models/gift.py`
- [ ] New field: `from_santa: Mapped[bool]`
- [ ] Field uses `mapped_column()` with Boolean type
- [ ] Default value is `False`
- [ ] Nullable is `False`
- [ ] Field has docstring explaining its purpose
- [ ] Type hints are correct (Mapped[bool], not Optional)
- [ ] Model imports Boolean from sqlalchemy
- [ ] No linting errors when running ruff/mypy

#### Implementation Details

**File**: `services/api/app/models/gift.py`

Add the following field to the Gift class (in alphabetical order or after status field):

```python
from sqlalchemy import Boolean

# ... existing imports ...

class Gift(Base):
    __tablename__ = "gifts"

    # ... existing fields (id, title, price, status, created_at, etc.) ...

    from_santa: Mapped[bool] = mapped_column(
        Boolean,
        default=False,
        nullable=False,
        comment="Marks gift as from Santa for surprise/personalization",
    )

    # ... existing relationships ...
```

#### Location in File

- Insert after `status` field or before relationships section
- Maintain alphabetical order if used in model
- Ensure proper indentation and spacing

#### Testing Checklist

- [ ] Model imports cleanly: `from app.models.gift import Gift`
- [ ] No type hint errors on import
- [ ] Column reflection works: `Gift.__table__.columns['from_santa']`
- [ ] Default value is correct: `Gift().from_santa == False`
- [ ] SQLAlchemy session can create/read/update gift with field

---

### T1.3: Update GiftCreate Schema

**Story ID**: P1-T3
**Story Points**: 1 pt
**Assigned Subagent(s)**: python-backend-engineer

#### Description

Update the `GiftCreate` Pydantic schema in `services/api/app/schemas/gift.py` to include the optional `from_santa` field with a default of `False`.

#### Acceptance Criteria

- [ ] File: `services/api/app/schemas/gift.py`
- [ ] Schema: `GiftCreate`
- [ ] New field: `from_santa: bool = Field(default=False, ...)`
- [ ] Field description explains purpose
- [ ] Default is `False` (most gifts are not from Santa)
- [ ] Fully required (not Optional)
- [ ] Pydantic validation passes for all cases:
  - `{"from_santa": true}` ✓
  - `{"from_santa": false}` ✓
  - `{}` (no from_santa, uses default) ✓

#### Implementation Details

**File**: `services/api/app/schemas/gift.py`

```python
from pydantic import BaseModel, Field

class GiftCreate(BaseModel):
    title: str = Field(..., description="Gift title")
    # ... existing fields (price, status, etc.) ...

    from_santa: bool = Field(
        default=False,
        description="Mark gift as from Santa for surprise/personalization"
    )

    # ... rest of schema ...
```

#### Location in Schema

- Add after `status` or at end of field definitions
- Use consistent Field() pattern with other bool fields
- Ensure description matches model docstring

#### Testing Checklist

- [ ] Schema validates: `GiftCreate(title="Test")`
- [ ] Default works: `GiftCreate(title="Test").from_santa == False`
- [ ] Explicit True works: `GiftCreate(title="Test", from_santa=True).from_santa == True`
- [ ] Explicit False works: `GiftCreate(title="Test", from_santa=False).from_santa == False`
- [ ] Invalid type rejected: `GiftCreate(title="Test", from_santa="true")` raises ValidationError
- [ ] JSON schema generation includes field

---

### T1.4: Update GiftUpdate Schema

**Story ID**: P1-T4
**Story Points**: 1 pt
**Assigned Subagent(s)**: python-backend-engineer

#### Description

Update the `GiftUpdate` Pydantic schema to include an optional `from_santa` field (allowing None to indicate "no update"). This schema is used for PATCH endpoints.

#### Acceptance Criteria

- [ ] File: `services/api/app/schemas/gift.py`
- [ ] Schema: `GiftUpdate`
- [ ] New field: `from_santa: bool | None = None`
- [ ] Allows partial updates (None means "don't change")
- [ ] Pydantic validation:
  - `{}` (no update) ✓
  - `{"from_santa": true}` ✓
  - `{"from_santa": false}` ✓
  - `{"from_santa": null}` ✓ (same as omitted)

#### Implementation Details

**File**: `services/api/app/schemas/gift.py`

```python
class GiftUpdate(BaseModel):
    title: str | None = None
    # ... existing optional fields ...

    from_santa: bool | None = None

    # ... rest of schema ...
```

#### Location in Schema

- Add near other update fields (in same section)
- Use `| None` syntax (Python 3.10+ union syntax)
- Default is always None for update schemas

#### Testing Checklist

- [ ] Empty update works: `GiftUpdate()` is valid
- [ ] Partial update works: `GiftUpdate(from_santa=True)` is valid
- [ ] None is accepted: `GiftUpdate(from_santa=None)` is valid
- [ ] Field is optional: no validation error without field
- [ ] JSON schema generation shows nullable

---

### T1.5: Update GiftResponse Schema

**Story ID**: P1-T5
**Story Points**: 1 pt
**Assigned Subagent(s)**: python-backend-engineer

#### Description

Update the `GiftResponse` Pydantic schema (used for API responses) to include the `from_santa` field. This ensures all gift endpoints return the field in responses.

#### Acceptance Criteria

- [ ] File: `services/api/app/schemas/gift.py`
- [ ] Schema: `GiftResponse` (may be called GiftOut or similar)
- [ ] New field: `from_santa: bool = Field(default=False)`
- [ ] Always included in responses (required, not optional)
- [ ] Schema serializes from ORM correctly
- [ ] Response validation:
  - From ORM model: `GiftResponse.model_validate(gift_orm)` ✓
  - From dict: `GiftResponse(from_santa=True)` ✓

#### Implementation Details

**File**: `services/api/app/schemas/gift.py`

```python
from pydantic import BaseModel, Field, ConfigDict

class GiftResponse(BaseModel):
    model_config = ConfigDict(from_attributes=True)  # for ORM conversion

    id: int
    title: str
    # ... existing fields ...
    from_santa: bool = Field(default=False, description="Gift marked as from Santa")

    # ... timestamps, relationships, etc. ...
```

#### ORM Conversion

- If using `from_attributes=True` config, Pydantic will auto-map `gift.from_santa` to response
- Ensure field order matches model or use ConfigDict to enable ordering

#### Testing Checklist

- [ ] ORM conversion works: `GiftResponse.model_validate(gift_orm_instance)`
- [ ] JSON serialization: `GiftResponse(...).model_dump_json()`
- [ ] Field appears in JSON output
- [ ] Default is correct when ORM field is True/False
- [ ] Field appears in OpenAPI schema

---

## Integration Testing

### Test Scenario 1: POST /gifts with from_santa

```bash
# Create a gift with from_santa=true
curl -X POST http://localhost:8000/gifts \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "LEGO Set",
    "price": 49.99,
    "status": "IDEA",
    "from_santa": true
  }'

# Expected: 201 Created with response including "from_santa": true
```

### Test Scenario 2: PATCH /gifts/{id} to toggle from_santa

```bash
# Update existing gift to mark as from Santa
curl -X PATCH http://localhost:8000/gifts/123 \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"from_santa": true}'

# Expected: 200 OK with updated response including "from_santa": true
```

### Test Scenario 3: GET /gifts includes from_santa

```bash
# List all gifts
curl -X GET http://localhost:8000/gifts \
  -H "Authorization: Bearer {token}"

# Expected: 200 OK with array of gifts, each including "from_santa" field
```

### Test Scenario 4: Backward Compatibility

```bash
# Create a gift WITHOUT from_santa (old client)
curl -X POST http://localhost:8000/gifts \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Toy",
    "price": 25.00,
    "status": "IDEA"
  }'

# Expected: 201 Created with "from_santa": false (default)
```

---

## Database Verification

### Local Testing Checklist

After migration and schema updates, verify in psql:

```sql
-- Check column exists and has correct type
\d gifts

-- Should show:
--  from_santa | boolean |           | not null | false

-- Verify default on insert
INSERT INTO gifts (title, status, user_id) VALUES ('Test Gift', 'IDEA', 1);
SELECT from_santa FROM gifts WHERE title = 'Test Gift';
-- Should return: false

-- Verify update works
UPDATE gifts SET from_santa = true WHERE title = 'Test Gift';
SELECT from_santa FROM gifts WHERE title = 'Test Gift';
-- Should return: true

-- Clean up
DELETE FROM gifts WHERE title = 'Test Gift';
```

---

## Deployment Notes

### Pre-Deployment
- [ ] Run migration in development environment
- [ ] Verify no data loss or corruption
- [ ] Test rollback scenario
- [ ] Review migration script for performance (should be instant; small schema change)

### Production Deployment
- [ ] Schedule migration during low-traffic window (not necessary for this change, but good practice)
- [ ] Take database backup before running
- [ ] Run migration: `alembic upgrade head`
- [ ] Verify migration completed: `alembic current`
- [ ] Monitor error logs for schema mismatch issues

### Rollback Plan
- [ ] If needed: `alembic downgrade -1` (drops from_santa column)
- [ ] Verify column removed: `\d gifts`
- [ ] No data loss (column was added, so downgrade is safe)

---

## Summary

Phase 1 is a quick foundation phase that adds one boolean column and updates three schemas. No changes to existing API endpoints are needed; they automatically support the new field through the updated schemas.

**Effort**: 1-2 days (low complexity)

**Unblocks**: All Phase 2-5 frontend work can begin immediately

**Next**: Move to [Phase 2-5: Frontend Components](phase-2-5-frontend.md)

---

**Phase Version**: 1.0
**Last Updated**: 2025-12-22
**Status**: Ready for Implementation
